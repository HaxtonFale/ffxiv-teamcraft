<ng-container *ngIf="gearset$ | async as gearset">
  <ng-container *ngIf="stats$ | async as stats">
    <div class="editor-container" #editorContainer>
      <div fxLayout="row" fxLayoutAlign="flex-start center" fxLayoutGap="5px" class="page-title">
        <span class="gearset-name">{{gearset.name}}</span>
        <span class="companion-svg job-icon" [innerHTML]="gearset.job | jobUnicode"></span>
      </div>

      <nz-collapse>
        <nz-collapse-panel [nzHeader]="'GEARSETS.Filters' | translate" class="filters">
          <form (ngSubmit)="submitFilters()" [formGroup]="itemFiltersform" nz-form nzLayout="inline" fxLayout="row" fxLayoutAlign="center center">
            <!--Ilvl filter-->
            <nz-form-item fxLayout="row" fxLayoutAlign="center center">
              <nz-form-label nzFor="ilvl">{{'filters/ilvl' | translate}}</nz-form-label>
              <nz-form-control>
                <nz-input-group fxLayout="row" class="input-min-max">
                  <nz-input-number [nzMax]="999" [nzMin]="0" [nzPrecision]="0" formControlName="ilvlMin"
                                   id="ilvl" class="min"></nz-input-number>
                  <input disabled nz-input placeholder="-" type="text" class="input-splitter">
                  <nz-input-number [nzMax]="999" [nzMin]="1" [nzPrecision]="0"
                                   formControlName="ilvlMax" class="max"></nz-input-number>
                </nz-input-group>
              </nz-form-control>
            </nz-form-item>
            <!--Elvl filter (equipment level)-->
            <nz-form-item fxLayout="row" fxLayoutAlign="center center">
              <nz-form-label nzFor="elvl">{{'filters/lvl' | translate}}</nz-form-label>
              <nz-form-control>
                <nz-input-group fxLayout="row" class="input-min-max">
                  <nz-input-number [nzMax]="gearset.level" [nzMin]="0" [nzPrecision]="0" formControlName="elvlMin"
                                   id="elvl" class="min"></nz-input-number>
                  <input disabled nz-input placeholder="-" type="text" class="input-splitter">
                  <nz-input-number [nzMax]="gearset.level" [nzMin]="1" [nzPrecision]="0"
                                   formControlName="elvlMax" class="max"></nz-input-number>
                </nz-input-group>
              </nz-form-control>
            </nz-form-item>
            <nz-form-item>
              <nz-form-control>
                <button nz-button nzType="primary" [disabled]="!itemFiltersform.valid">{{'ITEMS.Apply_filters' | translate}}</button>
              </nz-form-control>
            </nz-form-item>
          </form>
        </nz-collapse-panel>
      </nz-collapse>

      <div fxLayout="column" fxLayoutGap="10px" *ngIf="items$ | async as chunks">
        <div nz-row *ngFor="let categories of chunks; trackBy: trackByChunk">
          <div nz-col [nzMd]="stats.length > 3 ? 24 : 12" nzSm="24" class="category-card" [class.full]="stats.length > 3" [class.last]="last"
               [class.first]="first"
               *ngFor="let category of categories;let last=last; let first=first; trackBy: trackByCategory">
            <nz-card [nzTitle]="cardTitleRef">
              <ng-template #cardTitleRef>
                <div nz-row>
                  <div nz-col [nzMd]="24 - stats.length * (stats.length > 3 ? 2 : 4)" fxLayout="row" fxLayoutGap="5px" fxLayoutAlign="flex-start center">
                    <div>{{('GEARSETS.SLOT.' + category.name) | translate}}</div>
                    <i nz-icon nzType="warning" nzTheme="twotone" nzTwotoneColor="#f5222d"
                       *ngIf="!gearset[category.property] && category.name !== 'SoulCrystal'"></i>
                  </div>
                  <div nz-col [nzMd]="stats.length > 3 ? 2 : 4" *ngFor="let stat of stats;let lastStat = last" class="item-stat-row" [class.last]="lastStat">
                    <b>{{stat.id | baseParamName | i18n}}</b>
                  </div>
                </div>
              </ng-template>
              <div fxLayout="column">
                <ng-container *ngFor="let row of category.items;let last=last; let odd = odd; trackBy: trackByItemId">
                  <div nz-row class="item-row" [class.selected]="gearset[category.property]?.itemId === row.item.ID">
                    <div nz-col [nzMd]="24 - stats.length * (stats.length > 3 ? 2 : 4)" fxLayout="row" fxLayoutGap="5px" fxLayoutAlign="flex-start center">
                      <div fxLayout="row" fxLayoutAlign="flex-start center" fxLayoutGap="10px">
                        <label nz-checkbox [nzChecked]="gearset[category.property]?.itemId === row.item.ID"
                               (nzCheckedChange)="$event?setGearsetPiece(gearset, category.property, row.equipmentPiece):setGearsetPiece(gearset, category.property, null)"></label>
                        <div fxLayout="column" fxLayoutAlign="center center" fxLayoutGap="2px">
                          <app-item-icon [itemId]="row.item.ID" [width]="32 | ifMobile:24"></app-item-icon>
                          <div class="ilvl">{{'TOOLTIP.Ilvl' | translate}} {{row.item.LevelItem}}</div>
                        </div>
                        <div fxLayout="column" fxLayoutGap="5px">
                          <div fxLayout="row" fxLayoutGap="10px">
                            <div>{{row.item | xivapiI18n}}</div>
                            <nz-switch [(ngModel)]="row.equipmentPiece.hq"
                                       [nzDisabled]="row.item.CanBeHq === 0"
                                       (ngModelChange)="gearset[category.property]?.itemId === row.item.ID?setGearsetPiece(gearset, category.property, row.equipmentPiece):null"
                                       [nzCheckedChildren]="'COMMON.Hq' | translate"
                                       [nzUnCheckedChildren]="'COMMON.Nq' | translate"></nz-switch>
                          </div>
                          <div fxLayout="row" (click)="editMaterias(gearset, category.property, row.equipmentPiece)" class="materias">
                            <app-materia-slot-icon *ngFor="let materia of row.equipmentPiece.materias; let i = index"
                                                   nz-tooltip
                                                   [nzTitle]="materia === 0 ? null : materia | itemName | i18n"
                                                   [equipmentPiece]="row.equipmentPiece"
                                                   [index]="i"></app-materia-slot-icon>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div nz-col [nzMd]="stats.length > 3 ? 2 : 4" *ngFor="let stat of stats;let lastStat = last" class="item-stat-row" [class.last]="lastStat">
                    <span *ngIf="row.equipmentPiece | stat:stat.id as statValue"
                          nz-tooltip
                          [nzTitle]="statValue.bonus === 0 ? null :  statValue.value + ' + ' + statValue.bonus"
                          [class.has-bonus]="statValue.bonus > 0">
                      {{(statValue.value + statValue.bonus) > 0 ? (statValue.value + statValue.bonus) : '-'}}
                    </span>
                    </div>
                  </div>
                  <nz-divider *ngIf="!last"></nz-divider>
                </ng-container>
              </div>
            </nz-card>
          </div>
        </div>
      </div>
    </div>

    <div nz-row class="stats-footer" [style.width.px]="editorContainer.offsetWidth" [class.two-cols]="stats.length <= 3">
      <div nz-col [nzMd]="24 - stats.length * 2" class="footer-title" fxLayout="row" fxLayoutGap="5px">
        <div><b>{{'GEARSETS.Total_stats' | translate}}</b></div>
        <button nz-button nzShape="circle" nzSize="small" nz-tooltip [nzTitle]="'GEARSETS.Total_materias_needed' | translate"
                (click)="openTotalNeededPopup(gearset)">
          <i nz-icon nzType="calculator" nzTheme="outline"></i>
        </button>
      </div>
      <div nz-col [nzMd]="2" *ngFor="let stat of stats;let lastStat = last" class="item-stat-row" [class.last]="lastStat">
        <b>{{stat.value | number:'1.0-0':translate.currentLang}}</b>
      </div>
    </div>
  </ng-container>
</ng-container>

